version: '3.8'

services:
  # --- Infrastructure ---
  # Local Databases removed in favor of AWS RDS (Decoupled Architecture)

  temporal:
    image: temporalio/auto-setup:latest
    restart: always
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=letsplay
      - POSTGRES_PWD=letsplay-secure-pass
      - POSTGRES_SEEDS=${RDS_ENDPOINT}
      - SQL_HOST=${RDS_ENDPOINT}
      - VISIBILITY_SQL_HOST=${RDS_ENDPOINT}
      - DBNAME=temporal
      - VISIBILITY_DBNAME=temporal_visibility
      - SQL_TLS=true
      - SQL_TLS_CA=/etc/ssl/certs/ca-certificates.crt
      - SQL_TLS_DISABLE_HOST_VERIFICATION=true
      - VISIBILITY_SQL_TLS=true
      - VISIBILITY_SQL_TLS_CA=/etc/ssl/certs/ca-certificates.crt
      - VISIBILITY_SQL_TLS_DISABLE_HOST_VERIFICATION=true
      - POSTGRES_TLS_ENABLED=true
      - POSTGRES_TLS_SKIP_VERIFY=true
      - POSTGRES_TLS_CA=/etc/ssl/certs/ca-certificates.crt
      - POSTGRES_SSLMODE=require
      - PGSSLMODE=require
      - PGSSLROOTCERT=/etc/ssl/certs/ca-certificates.crt
      - SQL_CONNECT_ATTRIBUTES=sslmode=require
      - VISIBILITY_SQL_CONNECT_ATTRIBUTES=sslmode=require
      - SKIP_DB_CREATE=true
    volumes:
      - ./rds-ca.pem:/etc/ssl/certs/ca-certificates.crt:ro
      - ./rds-ca.pem:/etc/ssl/cert.pem:ro
    networks:
      - letsplay-prod

  temporal-ui:
    image: temporalio/ui:latest
    restart: always
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
    ports:
      - "8081:8080"
    depends_on:
      - temporal
    networks:
      - letsplay-prod

  # --- Application ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${RDS_ENDPOINT}:5432/letsplay?sslmode=verify-ca&sslrootcert=/app/rds-ca.pem
      - SPRING_DATASOURCE_USERNAME=letsplay
      - SPRING_DATASOURCE_PASSWORD=letsplay-secure-pass
      - TEMPORAL_TARGET=temporal:7233
      - JAVA_TOOL_OPTIONS="-Xmx256m"
    volumes:
      - ./rds-ca.pem:/app/rds-ca.pem:ro
    depends_on:
      - temporal
    networks:
      - letsplay-prod

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - letsplay-prod

networks:
  letsplay-prod:
    driver: bridge

# Volumes for local data are no longer needed for DBs
